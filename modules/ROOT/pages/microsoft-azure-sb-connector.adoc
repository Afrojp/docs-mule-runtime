= Microsoft Azure Service Bus Connector
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../../assets/images/

Support Category: Select

Microsoft Azure Service Bus Connector version 2.0.0

The Azure Service Bus connector enables message integration with Azure Service Bus on the cloud. This connector supports communication with queues and topics. In addition, you can use the built-in management API to discover Azure Service Bus objects automatically and to provision them.

== Prerequisites

This document assumes that you are familiar with Mule, Anypoint Connectors, Anypoint Studio, Mule concepts, elements in a Mule flow, and Global Elements.

You need login credentials to test your connection with your target resource. You can use Basic Authentication, or you can pass credentials in a connection string.

For software requirements and compatibility
information, see the connector's release notes.

== To Install the Connector in Anypoint Studio
. In Anypoint Studio, click the Exchange icon in the Studio task bar.
. Click *Login* in Anypoint Exchange.
. Search for the connector and click *Install*.
. Follow the prompts to install the connector.

When Studio has an update, a message displays in the lower right corner, which you can click to install the update.

== To Configure the Connector Using the Studio Visual Editor
. Drag and drop the HTTP connector onto the Studio canvas.
+
image::microsoft-azure-sb-listener.png[Trigger options]
+
. To configure the HTTP connector, enter these values:
+
image::microsoft-azure-sb-httpListenerConfig.png[Http Listener configuration]
+
** *Protocol*: Protocol selected for the HTTP endpoint. This can be HTTP or HTTPS (secure).
** *Host*: IP address where the Mule application listens for requests.
** *Port*: Port where the Mule application listens for requests.
** *Base Path*: Path to the port where the Mule application listens for requests.
. Select the connector from palette.
+
image::microsoft-azure-sb-palette.png[add connector]
+
. Drag and drop the connector onto the canvas.
. Configure global elements for the connector, as shown below.
+
image::microsoft-azure-sb-config.png[Configuration]
+
* **Connection String**
+
image::microsoft-azure-sb-cs.png[General]
+
[%header%autowidth.spread]
|===
|Field |Description
|*Name* | Name of the connection string.
|*Service Namespace* | Name of the service namespace to address Service Bus resources within your application.
|*Connection string* | Link provided by the Microsoft Azure portal that contains all needed connection parameters.
|===
* **Shared Access Signature**
+
image::microsoft-azure-sb-shared-access.png[General]
+
[%header%autowidth.spread]
|===
|Field |Description
|*Name* | Name of the shared access signature.
|*Service Namespace* | Name of the service namespace to address Service Bus resources within your application.
|*SAS Tokens* | Click *Create Object Manually* to generate a SAS Token.
|===

* **Username Password**
+
image::microsoft-azure-sb-userandpassword.png[General]
+
[%header%autowidth.spread]
|===
|Field |Description
|*Name* | Name of the username password settings.
|*Service namespace*| Name of the service namespace to address Azure Service Bus resources within your application.
|*Shared Access Key Name* | Name of the access key configured on the Azure Service Bus namespace. An access key created at a lower level, such as a topic-level shared key, does not work with this option unless you disable the connectivity test at startup.
|*Shared Access Key* | 56-bit primary key.
|===

=== Sources

==== Queue Listener Configuration

Configure the Queue Listener as follows:

image::microsoft-azure-sb-queuereceiver.png[Queue Source]

[%header%autowidth.spread]
|===
|Field |Description
|*Queue name* | Queue to receive events. To receive events from the dead letter queue, specify `QueueName/$deadletterqueue`.
|*Receive Mode*
a|
* MANUAL: User must manually acknowledge messages.
* AUTOMATIC: Message is acknowledged from the queue and then deleted from the queue after it is received.
If a message is not acknowledged, it times out and goes to the end of the queue.
|*Server timeout (ms)*| Maximum duration in milliseconds within which the client keeps renewing the message lock if the processing of the message is not completed by the handler.
|*Prefetch count*| When `Prefetch` is enabled in any of the official Service Bus clients, the receiver acquires additional messages, up to the `PrefetchCount` limit. This can be more messages than what the application initially requested. Set this field to 0 to disable prefetching.
|*Cron Expression*| (Optional) UNIX CRON expression that specifies when to trigger the receiver action. For example setting this field to `0 0 * * *`  triggers the receiver action at midnight (00:00) every day.
|*Max messages to receive*| Maximum number of messages to receive during the scheduled operation.
|===

==== Subscription Listener

Configure the Subscription Listener as follows:

image::microsoft-azure-sb-topicreceiver.png[Topic Source]

[%header%autowidth.spread]
|===
|Field |Description
|*Topic* | Topic name to which to connect.
|*Subscription*| Subscription to receive events. To receive events from the dead letter queue, specify `QueueName/$deadletterqueue`.
|*Receive Mode*
a|
* MANUAL: User must manually acknowledge messages.
* AUTOMATIC: Message is acknowledged from the queue and then deleted from the queue after it is received.
If a message is not acknowledged, it times out and goes to the end of the queue.
|*Server timeout (ms)*| Maximum duration within which the client keeps renewing the message lock if the processing of the message is not completed by the handler.
|*Prefetch Count*| When `Prefetch` is enabled in any of the official Service Bus clients, the receiver acquires additional messages, up to the `PrefetchCount` limit. This can be more messages than what the application initially requested. Set this field to 0 to disable prefetching.
|*Cron Expression*| (Optional) UNIX CRON expression that specifies when to trigger the receiver action. For example, setting this field to `0 0 * * *`  triggers the receiver action at midnight (00:00) every day.
|*Max. Messages to Receive*| Maximum number of messages to receive during the scheduled operation.
|===

== Use Case: Studio

=== Get Queue list

image::microsoft-azure-sb-flow.png[General]

. Create a new Mule application in Studio, and select an HTTP Connector as a source in the new flow.
. Add a new HTTP Connector Configuration global element:
.. Enter the following values for the `Host` and `Port` fields:
+
[%header%autowidth.spread]
|===
|Parameter |Value
|*Host* |0.0.0.0
|*Port* |8081
|===
+
.. Click *Save*.
. Assign the Global configuration to the HTTP Listener.
. In the *Path* field for the HTTP Listener path, enter `/list`.
. Drag and drop a new *Microsoft Azure Service Bus* component on the flow.
. Configure the Microsoft Azure Service Bus connector global element with its environment values.
. Select the `List queues` operation in the dropdown option.
. Save and run the project as a Mule Application.

== Use Case: XML

[source,code]
----
<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:http="http://www.mulesoft.org/schema/mule/http"
     xmlns:microsoft-azure-service-bus="http://www.mulesoft.org/schema/mule/microsoft-azure-service-bus" xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking"
     xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
     xmlns:spring="http://www.springframework.org/schema/beans"
     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xsi:schemaLocation="http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans-current.xsd
              http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
              http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
              http://www.mulesoft.org/schema/mule/microsoft-azure-service-bus http://www.mulesoft.org/schema/mule/microsoft-azure-service-bus/current/mule-microsoft-azure-service-bus.xsd
              http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd">
      <http:listener-config name="HTTP_Listener_Configuration" host="0.0.0.0" port="8081" doc:name="HTTP Listener Configuration"/>
             <microsoft-azure-service-bus:connection-string-config name="Microsoft_Azure_Service_Bus__Connection_string" connectionString="${config.cs}" namespace="${config.namespace}" doc:name="Microsoft Azure Service Bus: Connection string"/>
    <flow name="list-queue">
        <http:listener config-ref="HTTP_Listener_Configuration" path="/" doc:name="HTTP"/>
        <microsoft-azure-service-bus:list-queues config-ref="Microsoft_Azure_Service_Bus__Connection_string" doc:name="list queues"/>
    </flow>
</mule>

----

== Additional Information

=== Queue and Subscription Listener Operations

The output payload is a string with the message. Additional attributes are returned in the Outbound Properties.

=== Using Restricted Access Policies

In situations where you have restricted access to your resources (to only send/receive amqps messages), enable the option *AMQPS-only credentials* inside the *Advanced* tab.
