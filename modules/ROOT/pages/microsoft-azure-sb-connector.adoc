= Microsoft Azure Service Bus Connector
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../../assets/images/

Support Category: Select

Microsoft Azure Service Bus Connector version 2.0.0

The Azure Service Bus connector enables message integration with Azure Service Bus on the cloud. This connector supports communication with queues and topics. In addition, you can use the built-in management API to discover Azure Service Bus objects automatically and to provision them.

== Prerequisites

This document assumes that you are familiar with Mule, Anypoint Connectors, Anypoint Studio, Mule concepts, elements in a Mule flow, and Global Elements.

You need login credentials to test your connection with your target resource. You can use Basic Authentication, or you can pass credentials in a connection string.

For software requirements and compatibility
information, see the connector's release notes.

== Install the Connector in Anypoint Studio
. In Anypoint Studio, click the Exchange icon in the Studio task bar.
. Click *Login* in Anypoint Exchange.
. Search for the connector and click *Install*.
. Follow the prompts to install the connector.

When Studio has an update, a message displays in the lower right corner, which you can click to install the update.

== Configure the Connector Using the Studio Visual Editor
. Drag and drop the HTTP connector onto the Studio canvas.
+
image::microsoft-azure-sb-listener.png[Trigger options]
+
. To configure the HTTP connector, enter these values:
+
image::microsoft-azure-sb-httpListenerConfig.png[Http Listener configuration]
+
** *Protocol*: Protocol selected for the HTTP endpoint. This can be HTTP or HTTPS (secure).
** *Host*: IP address where the connector listens for requests.
** *Port*: Port where the connector listens for requests.
** *Base Path*: Path to the port where the connector listens for requests.
. Select the connector from palette.
+
image::microsoft-azure-sb-palette.png[add connector]
+
. Drag and drop the connector onto the canvas.
. Configure global elements for the connector, as shown below.
+
image::microsoft-azure-sb-config.png[Configuration]
+
* *Connection string*
+
image::microsoft-azure-sb-cs.png[General]
+
[%header%autowidth.spread]
|===
|Field |Description
|*Name* | Name of the connection string.
|*Service namespace* | Name of the service namespace to address Service Bus resources within your application.
|*Connection string* | Link provided by the Microsoft Azure portal that contains all needed connection parameters.
|===
* *Shared access signature*
+
image::microsoft-azure-sb-shared-access.png[General]
+
[%header%autowidth.spread]
|===
|Field |Description
|*Name* | Name of the shared access signature.
|*Service namespace* | Name of the service namespace to address Service Bus resources within your application.
|*SAS tokens* | Click *Create Object Manually* to generate a SAS Token.
|===

* *Username password*
+
image::microsoft-azure-sb-userandpassword.png[General]
+
[%header%autowidth.spread]
|===
|Field |Description
|*Name* | Name of the username password settings.
|*Service namespace*| Name of the service namespace to address Azure Service Bus resources within your application.
|*Shared access key name* | Name of the access key configured on the Azure Service Bus namespace. An access key created at a lower level, such as a topic-level shared key, does not work with this option unless you disable the connectivity test at startup.
|*Shared access key* | 56-bit primary key.
|===

=== Sources

The Microsoft Azure Service Bus connector has two sources:

* <<queuelistener>>
* <<subscriptionlistener>>

[[queuelistener]]
==== Queue Listener Configuration

Configure the *Queue listener* source as follows:

image::microsoft-azure-sb-queuereceiver.png[Queue Source]

[%header%autowidth.spread]
|===
|Field |Description
|*Queue name* | Queue to receive events. To receive events from the dead letter queue, specify `QueueName/$deadletterqueue`.
|*Receive mode*
a|
* `MANUAL`: User must manually acknowledge messages.
* `AUTOMATIC`: Message is acknowledged from the queue and then deleted from the queue after it is received.
If a message is not acknowledged, it times out and goes to the end of the queue.
|*Server timeout (ms)*| Maximum duration in milliseconds within which the client keeps renewing the message lock if the processing of the message is not completed by the handler.
|*Prefetch count*| When `Prefetch` is enabled in any of the official Service Bus clients, the receiver acquires additional messages, up to the `PrefetchCount` limit. This can be more messages than what the application initially requested. Set this field to 0 to disable prefetching.
|*Cron Expression*| (Optional) UNIX CRON expression that specifies when to trigger the receiver action. For example setting this field to `0 0 * * *`  triggers the receiver action at midnight (00:00) every day.
|*Max. messages to receive*| Maximum number of messages to receive during the scheduled operation.
|===

[[subscriptionlistener]]
==== Subscription Listener Configuration

Configure the *Subscription listener* source as follows:

image::microsoft-azure-sb-topicreceiver.png[Topic Source]

[%header%autowidth.spread]
|===
|Field |Description
|*Topic* | Topic name to which to connect.
|*Subscription*| Subscription to receive events. To receive events from the dead letter queue, specify `QueueName/$deadletterqueue`.
|*Receive Mode*
a|
* MANUAL: User must manually acknowledge messages.
* AUTOMATIC: Message is acknowledged from the queue and then deleted from the queue after it is received.
If a message is not acknowledged, it times out and goes to the end of the queue.
|*Server timeout (ms)*| Maximum duration within which the client keeps renewing the message lock if the processing of the message is not completed by the handler.
|*Prefetch Count*| When `Prefetch` is enabled in any of the official Service Bus clients, the receiver acquires additional messages, up to the `PrefetchCount` limit. This can be more messages than what the application initially requested. Set this field to 0 to disable prefetching.
|*Cron Expression*| (Optional) UNIX CRON expression that specifies when to trigger the receiver action. For example, setting this field to `0 0 * * *`  triggers the receiver action at midnight (00:00) every day.
|*Max. Messages to Receive*| Maximum number of messages to receive during the scheduled operation.
|===

== Use Cases

This topic contains the following use cases:

* <<basic>>
* <<manualack>>
* <<scheduled>>
* <<batch>>
* <<enqueuing>>

[[basic]]
=== Send a Message to a Queue or Topic

The following example configures a Mule app to send a message to an Amazon Azure Service Bus queue or topic:

. Create a new Mule app in Studio.
. Add an *HTTP* connector as the flow source.
. In the HTTP connector configuration, set the *Port* field to `8081` and the *Path* field to`/send`.
. Add a *Set Payload* or *Transform Message*, and create a message for the queue.
. Drag the *Microsoft Azure Service Bus* connector to the flow, and then configure the connector. Set the "Publish message" operation, "Destination Type" (`QUEUE` or `TOPIC`) and the "Destination name".
. Since the "Publish message" operation has no return value, use another *Set Payload* to return a message: `#["message sent"]`.
** Select the *Publish message* operation and *Destination type* (`QUEUE` or `TOPIC`)
** Enter the the *Destination name*.
. Since the *Publish message* operation has no return value, use another *Set Payload* to return a message: `#["message sent"]`.

When you call `http://localhost:8081/send`, the connector uploads the message to the queue.

[[manualack]]
=== Receive Messages from a Queue or Topic with a Manual Acknowledge Message

The following example configures a Mule app to send an acknowledgement after receiving a message from a queue or topic.

. Create a new Mule app in Studio.
. Add a *Microsoft Azure Service Bus* connector as the flow source, and configure the connector:
** In the *Operation field*, select *Queue listener* or *Subscription listener*.
** Set the *Queue* field or *Topic* field to the desired destination, and set the *Receive mode* to `MANUAL`.
. Drag a *Record Variable*, *Session Variable*, or *Variable* component to the flow.
. Store the *Lock Token* from the received message by using this expression: `#[message.inboundProperties.get('lockToken')]`
. Do something with the message. For testing purposes, a simple *Logger* would suffice.
. Add another *Microsoft Azure Service Bus* connector to the flow and set it to call the *Acknowledge message* operation. For the *Lock Token* field value, retrieve the stored *Lock Token*.

*Reviewers: I see a Lock field but not a Lock Token field. So should I replace Lock Token with Lock. Also, when you say "Do something with the message", can you be more specific?*

The connector processes every message received and acknowledges each message that is processed successfully.

To have the connector automatically acknowledge messages, set the *Receive Mode* field to `AUTOMATIC`.

[[scheduled]]
=== Scheduled Reception of Messages

The following example configures a Mule app that receives messages from a queue or topic on a specified schedule:

Create a Mule app to receive messages from a queue or topic, as described in <<basic>>.

When you create the app:

* Set the *Unix CRON Expression* field to a CRON expression that follows the UNIX standard. For example, to connect and receive messages every day at 8 AM, use `0 8 * * *`.
* Set the *Max. Messages to Receive* field to the maximum number of messages for the connector to receive every time the CRON expression triggers a receive.

The connector executes a batch receive every time the CRON expression commands it. Any number of available messages up to the maximum set will be retrieved and processed by the flow.

[[batch]]
=== Queue Send Batch

The following example configures a Mule app to send multiple messages to a queue:

. Create a Mule app to receive messages from a queue or topic, as described in <<basic>>.
. Replace the call to the *Publish message* operation with a call to the *Publish batch of messages* Operation. Make sure the *Destination type* and *Destination name* are properly set.
. When crafting the message, be sure to create a list of strings, since the app will send many messages simultaneously.
+
*Reviewers: what is the format of the list of strings? Is it comma-separated?*
+
To split a string by the commas, and send every piece as an individual message, drag a *Transform message* and use the following script:
```
%dw 1.0
%output application/java
---
payload splitBy ','
```

[[enqueuing]]
=== Schedule the Logical Enqueuing of a Message

The following example configures a Mule app to send a message to all listeners at a specified time:

. Create a Mule app to receive messages from a queue or topic, as described in <<basic>>.
. Fill in the "Scheduled enqueue time UTC" of the *Publish message* call parameter with the date/time you want the message to be dispatched. For example: `2019-06-27T21:16:46.866Z`.

*Reviewers, where is the Publish message call parameter? I am not seeing it.*

The message will be sent to the destination, which will dispatch the message at the specified time.

== REST operations

* Queue
** Create
** Get
** Get Size
** List
** Update
** Delete
* Topic
** Create
** Get
** List
** Update
** Delete
* Subscription
** Create
** Get
** Get Size
** List
** Update
** Delete
* Rule
** Create
** Get
** List
** Update
** Delete

== Additional Configuration Information

=== Queue and Subscription Listener Operations

The output payload is a string with the message. The connector returns additional attributes in the outbound properties.

=== Restricted Access Policies

In situations where you hour resources can only send and receive amqp messages, enable the option *AMQP-only credentials* inside the *Advanced* tab.

=== Handling a Very High Number of Messages

When handling a very high number of messages (such as thousands per second), especially if publishing to and reading from the same destination in the same Mule app, you might see messages like the following in the log:

```
[ERROR 2019-05-22 00:15:26,362 [ForkJoinPool.commonPool-worker-3] com.microsoft.azure.servicebus.MessageAndSessionPump: onMessage with message containing sequence number '95' threw exception com.mulesoft.connectors.microsoft.azure.servicebus.internal.error.exception.ConsumerException: Failed setting attributes from original API message.]
```
This issue relates to the processing strategy that Mule resolves automatically to "queue-asynchronous" when you configure the message listener in a flow.
If a message waits for more than 30,000 ms to be processed by the flow, Mule throws an exception that causes an error (timeout in the mule SEDA queue).

To avoid this error, create a custom queue-asynchronic configuration and do either or both of the following:

* Increase the number of threads in the `maxThreads` property. (The default is 16).
* Increase the waiting time in the `threadWaitTimeout`property`. (The default is 30,000 ms).

To modify the configuration:

. Select the flow.
. Select *General* -> *Optional Processing Strategy* -> *Processing Strategy Ref*.
. Click the plus sign.
. Add a new *Queued Asynchronous Processing Strategy*.

For more https://docs.mulesoft.com/mule-runtime/3.7/flow-processing-strategies#fine-tuning-a-queued-asynchronous-processing-strategy.

=== Random Errors when Using a Manual ACK

You might receive errors like this one when working with a high number of messages while a using manual ACK:

```
[com.mulesoft.connectors.microsoft.azure.servicebus.internal.error.exception.ConsumerException: Message with lockToken 2dc1312f-b263-4282-bbb0-566998eff6e6 could not be ACK at com.mulesoft.connectors.microsoft.azure.servicebus.internal.connection.Connection.ack(Connection.java:192)][ERROR 2019-05-22 00:17:30,822 [ReactorThread6f355ff5-5a36-487b-bb70-1a995a6ddf74] com.microsoft.azure.servicebus.primitives.CoreMessageReceiver: Completing pending updateState operation for delivery '?     ? &??I??=????' with exception com.microsoft.azure.servicebus.primitives.MessageLockLostException: The lock supplied is invalid. Either the lock expired, or the message has already been removed from the queue.]
```
When the connector performs a 'prefetch', the lockToken's validity time is fixed in relation to that moment. The problem arises when the lockToken's validity time is not long enough to process the entire batch of records. In these cases, Mule might throw an error because the lockToken expired before you do an ACK.

*Reviewers, where do you do this?*

To prevent this issue, reduce the size of the prefetch (default to 100), and increase the validity time of the lockToken, or both. You can do this when creating the queue/subscription from the connector, in the lock duration property or from Azure portal for existing queues). The maximum duration value for the lock token in Azure is 5 minutes (300 seconds).

=== Reduce Noise in Mule Apps Logs

In some circumstances, the underlying library used by the connector might regularly log complete stacktraces with level WARN. These messages do not represent an issue, but they can clutter the logs. To reduce the noise in the logs, make either of the following changes to the `src/main/resources/log4j2.xml` file:

* Specify an *AsyncLogger* for the library's package, raising the level of the log:

```
<!-- Recommended for packages not belonging to Mule -->
<AsyncLogger name="com.microsoft.azure.servicebus" level="ERROR"/>
```

* Add a *RegexFilter* to the existing appender (E.g. RollingFile):

```
<!-- Avoids the log of messages that contain the specified regexp -->
<RegexFilter regex = ".message to filter.*" onMatch="DENY" onMismatch="ACCEPT"/>
```
IMPORTANT: If the message is multiline, RegexFilter might not work correctly.

=== Listeners (Sources) in Network Disconnection and Reconnection Scenarios

In situations were there are network connection problems, you can direct the source components for the Azure connector to automatically execute reconnection attempts by specifying a reconnection strategy. You can specify a reconnection strategy when you create or edit the connector configuration:

. In the *General* tab of the connector configuration, select the plus sign next to the *Connector Configuration* field.
. Select one of the *Connector Configuration* options.
. In the *Reconnection* tab, select *Standard Reconnection*.
. Optionally, specify a non-default value for the *Frequency (ms)* and *Reconnection Attempts* fields.
