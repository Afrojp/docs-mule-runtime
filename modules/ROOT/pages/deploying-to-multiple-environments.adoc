= Configuring Mule App for Deployment Anywhere
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: deploy, deploying, cloudhub, on premises, on premise, environment

Make sure you are familiar with the exercise of building and deploying Mule applications as discussed in this section before reading on. Throughout the different phases in the development lifecycle, like QA, pre-production or production, your application may need to be configured differently as server names, credentials, HTTP ports, and other similar parameters will vary.

As a developer facing this kind of variability, your goal is to produce a single Mule application for all your environments and to externalize all the environment-specific configuration parameters. This is the key to reproducible deployments.

You can configure your Mule application to facilitate deployment to one of many different environments, both on-premises and in the cloud. To do so, you must complete the following macro steps:

. In your application, create a properties file for each environment.

. Configure a properties placeholder in your application to look for the deployment environment upon launch.

. Configure an environment variable to point to a  specific environment during application deployment.

Consider externalizing other aspects of your configuration, like time-out values, polling frequencies, etc... even if they don't vary between environments. This will facilitate tuning and experimenting as the whole Mule application would become configurable through a single properties file.

link:../assets/attachments/multiple-envs-example.jar[Download Example Studio Application]


== Basic Anatomy

[WARNING]
====
If you're deploying multiple applications through a xref:shared-resources.adoc[Shared Resources] structure, then you shouldn't set anything in the properties files, as there might potentially be conflicts between the various apps that share a domain. Instead, you can set environment variables over the scope of the deployed app, its domain and other apps under that domain.

As explained in the Shared Resources page, in Studio you can create these variables through the *Environment tab* of the *Run Configurations menu*, reachable via the dropdown menu next to the Play button.
====

Consider the following Mule configuration fragment that defines an HTTP connector with variable configuration:

[source,xml,linenums]
----
<http:listener-config name="HttpListenerConfiguration"
                      doc:name="HTTP Listener Configuration"
                      host="${host}"
                      port="${port}"
                      basePath="${path}" />
----

This example uses Spring's property placeholder resolution mechanism. The variable bits are clearly visible: the *base path*, *host*, and *port* can vary for each environment where this connector gets deployed in. When deploying your application, `mule.env` can be dynamically replaced by the particular environment you're deploying to, such as `qa` or `prod`.

To provide values for these variables, we use a Yaml configuration file:

[source,text,linenums]
----
path: "test/products"
host: "localhost"
port: 8082
----

You could then add also a second Yaml file with other values assigned to the same variables and entirely avoid having to touch your application's code to change these values:

[source,text,linenums]
----
path: "products"
host: "www.acme.com"
port: 8081
----

[TIP]
====
Use a consistent naming strategy for your properties and make them unique across applications: this will greatly facilitate re-use across teams.

A good strategy is to use the application name or ID in the default and override properties file names.
====

== Configuring an Application to Deploy in Multiple Environments

Follow the steps below to configure your application with variable properties.


[.ex]
=====
[discrete.view]
=== Using Studio Visual Editor

. Define a list of environments you wish to support in your application. For example, one common use case involves configuring the application to support both Production and a QA environments.

We will define the variable `variable` in the environments `prod` and `qa` and test it using a single application.

. Right-click the  `src/main/resources`  folder, then select  *New*  >  *File*   to create a properties file for each environment you wish to support. For example:
** `qa.yaml`
** `prod.yaml`
+
image::deploying-to-multiple-environments-01.png[]

. Double-click each of these new files to open them in new tabs in Studio. By editing them, you can configure the properties of the environment that correspond to the filename. For example, you may wish to add the properties as per the images below. Keep in mind that you can use these properties anywhere in your application.
+
image::deploying-to-multiple-environments-02.png[]
+
image::deploying-to-multiple-environments-03.png[]

. Close the properties files.

. Click in the Global Elements tab of your Studio project, below the canvas.

. *Create* a new global element.  When selecting the element type, pick *Configuration properties*  under *Global Configurations*.
+
image::deploying-to-multiple-environments-04.png[]

. Set the value of the *File* field to `${env}.yaml`
+
[TIP]
====
Learn more about xref:configuring-properties.adoc[configuring variable properties].
====

. *Create* a new property to add a default environment. When selecting the element type, pick *Global Property*  under *Global Configurations*.
+
image::deploying-to-multiple-environments-05.png[]

. Set a value to the property.
+
image::deploying-to-multiple-environments-06.png[]

. You can change the environment by editing the configured *Global Property* value (it is not the only way, see above).


[discrete.view]
=== Using XML Editor

. Define a list of environments you wish to support in your application. For example, one common use case involves configuring the application to support both Production and a QA environments.

We will define the variable `variable` in the environments `prod` and `qa` and test it using a single application.

. Right-click the  `src/main/resources`  folder, then select  *New*  >  *File*   to create a properties file for each environment you wish to support. For example:
** `qa.yaml`
** `prod.yaml`
+
image::deploying-to-multiple-environments-01.png[]

. Double-click each of these new files to open them in new tabs in Studio. By editing them, you can configure the properties of the environment that correspond to the filename. For example, you may wish to add the properties as per the images below. Keep in mind that you can use these properties anywhere in your application.
+
image::deploying-to-multiple-environments-02.png[]
+
image::deploying-to-multiple-environments-03.png[]

. Close the properties files.

. Click in the Configuration XML tab of your Studio application, below the canvas.

. Add a *configuration-properties* element to the XML file and let the file name configurable.

[source,xml,linenums]
----
<configuration-properties doc:name="Configuration properties" file="${env}.yaml" />
----

[TIP]
====
Learn more about xref:configuring-properties.adoc[configuring variable properties].
====

. Add a *Global Property* element to set the default environment name.

[source,xml,linenums]
----
<global-property doc:name="Global Property" name="env" value="qa" />
----

. You can change the environment by editing the configured *Global Property* value (it is not the only way, see above).


== Deploying to a Specific Environment

. Use the procedures below to deploy an application to a specific environment – prod, qa, etc. – from Studio.

[.ex]
=====
[discrete.view]
=== On-Premise

[discrete]
==== Studio

. In the Package Explorer, right-click the filename of the project you wish to deploy, then select *Run As* > *Mule Application*.

. Studio automatically deploys your application according the environment variable you specified in the *Global Property* from the procedure above.

. Again in the Package Explorer, right-click the filename of the project you wish to deploy, then select *Run As* > *Run Configurations...*.
+
image::deploying-to-multiple-environments-07.png[]

. And define the System Property in the `Arguments` tab 
+
image::deploying-to-multiple-environments-08.png[]

. Click the `Run` button, and that's it. The properties configured in `prod.yaml` will be used instead of the ones defined in `qa.yaml`.


[discrete]
==== Standalone

Identify the the environment in which to deploy your application at runtime with an environment variable. Execute the command to run your mule application as per the example below.

[source,console,linenums]
----
$ mule -M-Dmule.env=prod
----


[discrete.view]
=== CloudHub

. In the Package Explorer, right-click the filename of the project you wish to deploy, then select *Anypoint Platform* -> *Deploy to Cloud*.
+
image::deploying-to-multiple-environments-09.png[]

. Complete the needed data, and click the *Properties* tab.

. Add a new environment variable. Set the *Key* of this new variable to *env* and it's value to the environment you wish to deploy to (*prod* in this example).
+
image::deploying-to-multiple-environments-10.png[]

. Click *Deploy Application* to deploy.
+
[TIP]
====
To learn more about deploying to test environments in CloudHub, access the *CloudHub Sandbox Environments* documentation.
====
=====


== See Also

* To learn more about deploying to test environments in CloudHub, access the CloudHub Sandbox Environments documentation.

* Learn more about xref:configuring-properties.adoc[Properties Placeholders] in Mule.

* Learn how to proceed when deploying multiple applications with xref:shared-resources.adoc[Shared Resources]