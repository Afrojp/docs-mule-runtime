= Configuring Environment Properties
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: deploy, deploying, cloudhub, on premises, on premise, environment

Throughout the different phases in the development lifecycle, like QA, pre-production or production, you may need to configure your application differently as server names, credentials, HTTP ports, and other similar parameters that can vary.

You can configure your Mule application to facilitate deployment to one of many different environments, both on-premises and in the cloud, by using different configuration files for your development environments (prod, qa, etc) so your application dynamically loads property files based on the environment you are working on. To do so, you must complete the following macro steps:

. Create a properties file for each environment in your application.

. Configure a properties placeholder in your application to look for the deployment environment upon launch.

. Configure an environment variable to point to a specific environment during application deployment.


Consider externalizing other aspects of your configuration, like time-out values, polling frequencies, etc. Even if they don't vary between environments. This will facilitate tuning and experimenting as the whole Mule application would become configurable through a single properties file.

link:../assets/attachments/multiple-envs-example.jar[Download Example Studio Application]


== Basic Anatomy

Review the following Mule configuration fragment that defines an HTTP connector with variable configuration:

[source,xml,linenums]
----
<http:listener-config name="HttpListenerConfiguration"
                      doc:name="HTTP Listener Configuration"
                      host="${host}"
                      port="${port}"
                      basePath="${path}" />
----

This example uses Spring's property placeholder resolution mechanism. The variable bits are clearly visible: the *base path*, *host*, and *port* can vary for each environment where this connector gets deployed in. When deploying your application, `mule.env` can be dynamically replaced by the particular environment you're deploying to, such as `qa` or `prod`.

To provide values for these variables, we use a Yaml configuration file:


----
path: "test/products"
host: "localhost"
port: 8082
----


You could entirely avoid having to touch your application's code values by adding a second Yaml file with other values assigned to the same variables:


----
path: "products"
host: "www.acme.com"
port: 8081
----

[TIP]
====
Use a consistent naming strategy for your properties and make them unique across applications. This will greatly facilitate re-use across teams.

A good strategy is to use the application name or ID in the default and override properties file names.
====

[WARNING]
====
If you're deploying multiple applications through a xref:shared-resources.adoc[Shared Resources] structure, you shouldn't set anything in the properties files, as there could be conflicts between the various apps that share a domain. Instead, you can set environment variables over the scope of the deployed app, its domain and other apps under that domain.

As explained in the Shared Resources page, in Studio you can create these variables through the *Environment tab* of the *Run Configurations menu*, reachable via the dropdown menu next to the Play button.
====

== Configuring Mule App to Deploy in Multiple Environments

To configure your application with variable properties review the following steps:

=== Using Studio Visual Editor

. Define a list of environments you wish to support in your application. For example, one common use case involves configuring the application to support both Production and a QA environments. +
We will define the variable `variable` in the environments `prod` and `qa` and test it using a single application.

[start=2]
. Right-click the `src/main/resources` folder, then select  *New*  >  *File*   to create a properties file for each environment you wish to support. For example:
** `qa.yaml`
** `prod.yaml`
+
image::deploying-to-multiple-environments-01.png[]

. Double-click each of these new files to open them in new tabs in Studio. By editing them, you can configure the properties of the environment that correspond to the filename. For example, you may wish to add the properties as per the following images. Keep in mind that you can use these properties anywhere in your application.
+
image::deploying-to-multiple-environments-02.png[]
+
image::deploying-to-multiple-environments-03.png[]

. Close the properties files.

. Click in the Global Elements tab of your Studio project, below the canvas.

. *Create* a new global element.  When selecting the element type, pick *Configuration properties*  under *Global Configurations*.
+
image::deploying-to-multiple-environments-04.png[]

. Set the value of the *File* field to `${env}.yaml`
+
[TIP]
====
Learn more about xref:configuring-properties.adoc[configuring variable properties].
====

. *Create* a new property to add a default environment. When selecting the element type, pick *Global Property*  under *Global Configurations*.
+
image::deploying-to-multiple-environments-05.png[]

. Set a value to the property.
+
image::deploying-to-multiple-environments-06.png[]

. You can change the environment by editing the configured *Global Property* value.

=== Using XML Editor

. Define a list of environments you wish to support in your application. For example, one common use case involves configuring the application to support both Production and a QA environments. +
We will define the variable `variable` in the environments `prod` and `qa` and test it using a single application.

[start=2]
. Right-click the  `src/main/resources`  folder, then select  *New*  >  *File*   to create a properties file for each environment you wish to support. For example:
** `qa.yaml`
** `prod.yaml`
+
image::deploying-to-multiple-environments-01.png[]

. Double-click each of these new files to open them in new tabs in Studio. By editing them, you can configure the properties of the environment that correspond to the filename. For example, you may wish to add the properties as per the following images. Keep in mind that you can use these properties anywhere in your application.
+
image::deploying-to-multiple-environments-02.png[]
+
image::deploying-to-multiple-environments-03.png[]

. Close the properties files.

. Click in the Configuration XML tab of your Studio application, below the canvas.

. Add a *configuration-properties* element to the XML file and let the file name configurable.

[source,xml,linenums]
----
<configuration-properties doc:name="Configuration properties" file="${env}.yaml" />
----

[TIP]
====
Learn more about xref:configuring-properties.adoc[configuring variable properties].
====

[start=7]
. Add a *Global Property* element to set the default environment name.

[source,xml,linenums]
----
<global-property doc:name="Global Property" name="env" value="qa" />
----
[start=8]
. You can change the environment by editing the configured *Global Property* value.


== Testing Configured Environment Properties in Studio

You can test that your application uses the specific environment you configured in your variables properties, by running the application in Mule embedded in Studio.

. In the Package Explorer view, right-click the filename of the project you wish to deploy, then select *Run As* > *Mule Application*.

. Studio automatically deploys your application according to the environment variable you specified in the *Global Property* from the previous procedure.

. Again in the Package Explorer view, right-click the filename of the project you wish to deploy, then select *Run As* > *Run Configurations...*.
+
image::deploying-to-multiple-environments-07.png[]

. Define the System Property in the `Arguments` tab.
+
image::deploying-to-multiple-environments-08.png[]

. Click the `Run` button to complete the procedure. The properties configured in `prod.yaml` will be used instead of the ones defined in `qa.yaml`.

== Deploying Mule Apps using your Specific Environment Configurations

Mule loads the environment variables when it starts, so depending on your deployment target (Cloudhub or On-premises) you need to set the environment when you deploy the app (CH) or when you start your Mule instance (On-premises)

=== Setting a Specific Environment when Starting Mule On-Premises

Identify the environment in which to deploy your application at runtime with an environment variable. Execute the command to run Mule in your environment as per the following example:

[source,console,linenums]
----
$ mule start -M-Denv=prod
----

Once Mule starts with your configured environment, you can deploy the application with your desired deployment method.


=== Setting a Specific Environment when Deploying to CloudHub

From Studio you can initiate the process to set your properties environment variables and deploy your application to CloudHub :

. In the Package Explorer view, right-click the filename of the project you wish to deploy, then select *Anypoint Platform* -> *Deploy to Cloud*.
+
image::deploying-to-multiple-environments-09.png[]

. Complete the requested data, and click the *Properties* tab.

. Add a new environment variable. Set the *Key* to *env* and its value to the environment you wish to deploy to (*prod* in this example).
+
image::deploying-to-multiple-environments-10.png[]

. Click *Deploy Application* to deploy.
+
//[TIP]
//====
//To learn more about deploying to test environments in CloudHub, access the *CloudHub Sandbox Environments* documentation.
//====

== See Also

* Learn more about xref:configuring-properties.adoc[Properties Placeholders] in Mule.

* Learn how to proceed when deploying multiple applications with xref:shared-resources.adoc[Shared Resources]
