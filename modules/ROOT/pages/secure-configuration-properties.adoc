= Secure Configuration Properties
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

To create secure configuration properties by encrypting them, review the following process:

. Create a secure properties file and define its properties.
. Encrypt and Decrypt the file values.
. Configure the secure properties file with the Mule Secure Configuration Properties Module.

== Attributes

First identify the secure configuration properties attributes and encrypting attributes used in the process:

[cols="1,3", options="header"]
|===
| Secure Configuration Properties Attributes |

| Name
| A unique name for your global secure configuration properties.

| Key
| The word or phrase to unlock the properties value according to the system property that you define in this field. For example, `${production.myproperty}` instructs the Mule runtime to demand the key at runtime.

| File
| The location of the file that the key unlocks.

| Encoding
| Encoding of the file that the key unlocks. The default value is UTF-8.

| File Level Encryption
| Set to `true` if the file itself is entirely encrypted. Default value is `false`.
|===

[cols="1,3", options="header"]
|===
| Secure Configuration Properties Encrypting Attributes |

| Algorithm
| The type of algorithm you use to encrypt the content of the property. See <<supported_algorithms>> for a complete list.

| Mode
| The procedure that allows the Mule runtime to repeatedly use a block cipher with a single key. See <<supported_modes>> for a full list.
|===

== Create a Secure Configuration Properties File and Define Its Properties

You can create a `.yaml` configuration file or a Spring-formatted `.properties` file. The recommended approach is to use a YAML configuration file, because it allows the addition of type validations and autocompletion. The Secure Configuration Properties module allows you to configure these supported file types. +

Create these files under `src/main/resources` inside your Mule project, or you can also use absolute paths. The secure properties configuration file can include secured and non-secured properties.

=== Define Secure Configuration Properties
Define secure properties in the file by encrypting the values between the sequence `![value]`. The file can contain encrypted and non-encrypted values that could be used anywhere in the Mule application.  +

The following `file1.yaml` example contains both encrypted and non-encrypted configuration properties values:
----
encrypted:
    value1: "![nHWo5JhNAYM+TzxqeHdRDXx15Q5R56YVGiQgXCoBCew=]"
    value2: "![nHWo6XyCADP+TzxqeHdRDXx15Q5R56YVGiQgXCoDFaj=]"

testPropertyA: "testValueA"
testPropertyB: "testValueB"
----

[NOTE]
The encrypted value must be enclosed in quotes so that it is read as a String.

The following `file1.properties` example contains the same previous configuration properties but uses a Spring-formatted properties file:
----
encrypted.value1=![nHWo5JhNAYM+TzxqeHdRDXx15Q5R56YVGiQgXCoBCew=]
encrypted.value2=![nHWo6XyCADP+TzxqeHdRDXx15Q5R56YVGiQgXCoDFaj=]

testPropertyA=testValueA
testPropertyB=testValueB
----

== Encrypt and Decrypt File Values with the Secure Properties Tool

You can download the https://docs.mulesoft.com/downloads/mule-runtime/4.2/secure-properties-tool.jar[JAR file] to use the Secure Properties Tool in the command line. The tool allows you to encrypt or decrypt single values, and complete files (both `.yaml` and `.properties` files). The tool supports three encryption modes: `string`, `file`, and `file-level`. +

Note that key sizes might depend on the Java Cryptography Extension (JCE) version. Since version 1.8.0_161, the AES key size needs to be of at least 32 characters (256 bytes), instead of 16 characters in previous versions.

[WARNING]
When using encrypted properties, it is especially important to **secure access to the operating system**. Anyone who can run a `ps` command or view a Java console will be able to see the decrypted values that are stored in the Mule app's memory.

=== Encrypt or Decrypt Single Values

Use the `string` mode to encrypt or decrypt a single value provided as a parameter. Run the following command:

[source,console.linenums]
----
java -jar secure-properties-tool.jar string <encrypt|decrypt> <algorithm> <mode> <key> <value>
----

Replace `<value>` with any desired string value you want to process, for example:

[source,console.linenums]
----
java -jar secure-properties-tool.jar string encrypt Blowfish CBC mulesoft "some value to encrypt"
----

=== Encrypt or Decrypt Files

The encryption tool is able to encrypt complete `.yaml` or `.properties` files.

* Use the `file` mode to encrypt all values inside a `.properties` file. The output is a file with the same properties, but its values are encrypted. Run the following command:
+
[source,console.linenums]
----
java -jar secure-properties-tool.jar file <encrypt|decrypt> <algorithm> <mode> <key> <input file> <output file>
----
+
For example, assume that this is the input file:
+
`example_in.yaml`
+
[source,yaml,linenums]
----
properties:
  example1:
    value: "Muleman is here"
  example2: "Max the mule"
----
+
If you run the command:
+
----
java -jar secure-properties-tool.jar file encrypt Blowfish CBC mulesoft example_in.yaml example_out.yaml
----
+
The output file is:
+
`example_out.yaml`
+
[source,yaml,linenums]
----
properties:
  example1:
    value: "![qCReIPK3jcqD7WR84ISSIQ==]"
  example2: "![En8lII21ZHrdIaINw0+mSA==]"
----

* Use the `file-level` mode to completely encrypt the properties file. The output is a file that is entirely encrypted.

Using as input the `example_in.yaml` file from the previous example, if you run the command:
----
java -jar secure-properties-tool.jar file-level encrypt Blowfish CBC mulesoft example_in.yaml example_out.yaml
----

The output file is: +
`example_out.yaml`

[source,txt,linenums]
----
k/J1EHyxJagOcyQELoaqIDCzzKc1bLGJiHY2dv6jzuhtVpP1LTlgK3y8EH7OkK5iuuu8kik3P5dCDMixZXwn/EV6xbUwLFKnEb4x1pUX6aopLP/KULm0pQ==
----

== Configure the File with the Mule Secure Configuration Properties Module

You can configure a secure properties file both in standalone XML or in Anypoint Studio, with the Mule Secure Configuration Properties Extension module available from https://anypoint.mulesoft.com/exchange/com.mulesoft.modules/mule-secure-configuration-property-module/[Exchange].

=== Configure Secure Configuration Properties in XML

In your XML flow, use the Secure Configuration Properties module `<secure-properties:config>` to configure the file. Review the following example: +

*Secure Configuration Properties with Default Values*
[source,xml,linenums]
----
<secure-properties:config key="${runtime.property}"
  file="file1.yaml" name="test">
    <secure-properties:encrypt/>
</secure-properties:config>

<global-property name="prop" value="my-${secure::property.key1}"/>
----
In the previous example: +

* The `<secure-properties:encrypt>` tag is required even when using the default values.
* The prefix `secure::` is required for loading the key.
[NOTE]
You have to use the `secure::` prefix to access all values inside a secure properties file, even if the values are non-encrypted. This behavior allows you to switch between files (or environments) without changing the entire configuration.

* A decryption key is passed into the Mule runtime engine at deployment time as a system environment variable `runtime.property`. This property must be the exact key used to encrypt the values stored in the `file1.yaml` file.
* The default encryption algorithm and mode is used.
* If the actual (decrypted) value of the property `property.key1` is, for example, `"property"`, the value of the property `prop` will be `"my-property"`.

You can also change the encryption algorithm and crypto mode by setting additional attributes of the `<secure-properties:encrypt>` tag, for example:

*Secure Configuration Properties with Custom Values*
[source,xml,linenums]
----
<secure-properties:config key="${runtime.property}"
  file="file1.properties" name="test">
    <secure-properties:encrypt algorithm="AES" mode="CBC"/>
</secure-properties:config>
----
In the previous example: +

* The `<secure-properties:encrypt>` tag uses the `AES` algorithm with `CBC` mode.

=== Configure Secure Configuration Properties in Studio

In Anypoint Studio, you can use this extension module by adding it as a dependency in your Mule app.

==== Install the Extension Module

. Open your Mule project in Anypoint Studio.

. Go to the Mule Palette.

. Select *Search in Exchange*, and search for the *Mule Secure Configuration Property Extension*.

. Add the extension.

==== Add and Configure Secure Configuration Properties to your App

. Go to your Mule app configuration file.

. Select the *Global Elements* tab.

. Click the *Create* button.

. From the search bar, select *Secure Properties Config*.

. Configure the global element with a *File* location, *Key*, *Algorithm*, *Mode*, *File level encryption*, and *Encoding*.

. Click *OK*.

image::secure-configuration-properties-studio.png[config extension]

==== Verify Secure Configuration Properties at Design Time
At design time in Studio, you can verify that secure configurations properties for a connector are set up correctly by testing the connector connection.
The following example shows a Salesforce connector configuration where its secure properties (username, password and token) are encrypted in a `.yaml` file. +
The `secure::` prefix is added before the property name definition, in order to access all values inside a secure properties file, even if the values are non-encrypted.

image::secure-configuration-properties-studio2.png[config extension2]

Click *Test Connection* to test the functionality of the connection and assure that the secure properties are read successfully.

== File Level Encryption
Since version 1.1.0 of the Secure Configuration Properties module, you can encrypt the entire file (not only the values of the properties). To use a file that its encrypted:

In your XML flow, you add the `fileLevelEncryption` attribute and set it to `true`:

[source,xml,linenums]
----
<secure-properties:config key="${runtime.property}" file="file1.yaml" fileLevelEncryption="true" name="test">
    <secure-properties:encrypt algorithm="AES" mode="CBC"/>
</secure-properties:config>
----

In Studio, in the Secure Configuration Properties window, select *True* for the *File level encryption*:

image::secure-configuration-properties-studio3.png[config extension3]




== Usage of Secure Configuration Properties

The following example shows how a flow uses the encrypted `encrypted.value1` value to set the payload. At runtime, the decryption algorithm is used to store the decrypted value of `encrypted.value1` into memory.

*Use of Encrypted Secure Properties*
[source,xml,linenums]
----
<flow name="main">
    <set-payload value="${secure::encrypted.value1}"/>
</flow>
----

The following example shows how flow uses a non-encrypted value from the same secure properties file:

*Use of Non-encrypted Properties*
[source,xml,linenums]
----
<flow name="mainNonEncrypted">
    <set-payload value="${secure::testPropertyA}"/>
</flow>
----

=== Set Secure Configuration Properties File Dynamically

A common configuration use case is to set the file to depend on a property (for example, `env`) to determine which file to use. For example, to use a `development-properties` file in development stage (which could not be encrypted) or a production file (with encrypted values).

*Secure Configuration Properties with Environment File Defined*
[source,xml,linenums]
----
<secure-properties:config key="${runtime.property}" file="${env}-properties.yaml" name="test"/>
----

This way, the value of the property `env` determines which file to use to load the secure configuration properties. That `env` property could be set by a `global property`, system property, or environment property (see xref:configuring-properties.adoc[Configure Properties]).

*Secure Global Configuration Properties with Environment File Defined*
[source,xml,linenums]
----
<global-property name="env" value="dev"/>

<secure-properties:config key="${runtime.property}" file="${env}-properties.yaml" name="test"/>
----

This way, the default value for the `env` property will be `"dev"`, which can still be overriden with a system or environment property. Please note that this is *required* for metadata resolution in Anypoint Studio. If you do not define default values for the properties that are passed through the command line you will receive an error while creating application model for all message processors that depend on them.

=== Work with More than One Configuration File

You can define more than one secure configuration properties file to read properties from. To do so, simply define a `<secure-properties:config />` tag for each file you want to load. Each secure configuration properties file is independently configured with an encryption algorithm, cipher mode, and encryption/decryption key. None of these settings needs to be the same between secure configuration properties files. +
The following example shows how to use more than one configuration file:
[source,xml,linenums]
----
<secure-properties:config key="${runtime.property}" file="file1.yaml" name="test">
    <secure-properties:encrypt algorithm="AES" mode="CBC"/>
</secure-properties:config>

<secure-properties:config key="${runtime.property}" file="file2.yaml" name="otherConfig">
    <secure-properties:encrypt algorithm="AES" mode="CBC"/>
</secure-properties:config>
----



[[supported_crypto]]
== Supported Algorithms and Modes

[[supported_algorithms]]
=== Supported Algorithms

* AES (default)
* Blowfish
* DES
* DESede
* Camellia
* CAST5
* CAST6
* Noekeon
* Rijndael
* SEED
* Serpent
* Skipjack
* TEA
* Twofish
* XTEA
* RC2
* RC5
* RC6
* RCA

[[supported_modes]]
=== Supported Modes

* CBC (default)
* CFB
* ECB
* OFB


== Frequently Asked Questions

*What if a property is defined in multiple files?*

In that case, the actual property's value will be the one in which is first defined.

*What if I want to define a secure property to depend on a previously defined secure property?*

It is possible to define a property to depend on a previously defined one, just using the same syntax: `property=My dependent ${secure::dependent.property} value`.

Note that Secure Configuration Properties can depend on other Secure Configuration Properties, but not on other Mule configuration properties.

== See Also
* xref:configuring-properties.adoc[Configuring Properties].
